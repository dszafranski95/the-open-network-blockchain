Dapp-TON-Next

This project is built using Next.js and allows users to log in with a TON blockchain wallet, manage sessions, and perform transactions.
Getting Started

First, clone the repository and navigate to the project directory:

git clone https://github.com/your-repo/dapp-ton-next.git
cd dapp-ton-next

Install the dependencies:

npm install
# or
yarn install
# or
pnpm install
# or
bun install

Run the development server:

npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev

Open http://localhost:3000 with your browser to see the result.

You can start editing the page by modifying app/page.tsx. The page auto-updates as you edit the file.
Features

This project uses next/font to automatically optimize and load Inter, a custom Google Font.
TON Wallet Integration

This project integrates with the TON blockchain, allowing users to log in using their TON wallets. A session is created upon login, enabling users to perform transactions and interact with the blockchain.
Transaction Handling

Users can create and send transactions through the application. The transactions are crafted with predefined parameters for interacting with an EchoContract, ensuring that the value sent is returned to the sender for testing purposes.

### Learn More

To learn more about Next.js, take a look at the following resources:

-    Next.js Documentation - learn about Next.js features and API.
-    Learn Next.js - an interactive Next.js tutorial.

You can check out the Next.js GitHub repository - your feedback and contributions are welcome!
Deploy on Vercel

The easiest way to deploy your Next.js app is to use the Vercel Platform from the creators of Next.js.

Check out our Next.js deployment documentation for more details.
Code Overview
app/layout.tsx

This file sets up the layout for the application, including dynamically importing the TonConnectProvider to manage the TON wallet connection.

### code

import type { Metadata } from "next";
import { Inter } from "next/font/google";
import dynamic from 'next/dynamic';
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

const TonConnectProvider = dynamic(() => import('@/src/web3/TonConnectProvider'), { ssr: false });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <TonConnectProvider>
          {children}
        </TonConnectProvider>
      </body>
    </html>
  );
}


'app/TonProofDemoApi.ts'

This service manages the TON proof verification and handles API interactions related to the TON blockchain.

import {Account, ConnectAdditionalRequest, TonProofItemReplySuccess} from "@tonconnect/ui-react";
import './patch-local-storage-for-github-pages';

class TonProofDemoApiService {
  private localStorageKey = 'demo-api-access-token';
  private host = 'https://demo.tonconnect.dev';
  public accessToken: string | null = null;
  public readonly refreshIntervalMs = 9 * 60 * 1000;

  constructor() {
    this.accessToken = localStorage.getItem(this.localStorageKey);
    if (!this.accessToken) {
      this.generatePayload();
    }
  }

  async generatePayload(): Promise<ConnectAdditionalRequest | null> {
    try {
      const response = await (
        await fetch(`${this.host}/ton-proof/generatePayload`, {
          method: 'POST',
        })
      ).json();
      return {tonProof: response.payload as string};
    } catch {
      return null;
    }
  }

  async checkProof(proof: TonProofItemReplySuccess['proof'], account: Account) {
    try {
      const reqBody = {
        address: account.address,
        network: account.chain,
        proof: {
          ...proof,
          state_init: account.walletStateInit,
        },
      };

      const response = await (
        await fetch(`${this.host}/ton-proof/checkProof`, {
          method: 'POST',
          body: JSON.stringify(reqBody),
        })
      ).json();

      if (response?.token) {
        localStorage.setItem(this.localStorageKey, response.token);
        this.accessToken = response.token;
      }
    } catch (e) {
      console.log('checkProof error:', e);
    }
  }

  async getAccountInfo(account: Account) {
    const response = await (
      await fetch(`${this.host}/dapp/getAccountInfo?network=${account.chain}`, {
        headers: {
          Authorization: `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json',
        },
      })
    ).json();

    return response as {};
  }

  reset() {
    this.accessToken = null;
    localStorage.removeItem(this.localStorageKey);
    this.generatePayload();
  }
}

export const TonProofDemoApi = new TonProofDemoApiService();


'src/components/TxForm/TxForm.tsx'

This component provides a form for users to configure and send transactions through the TON blockchain.

"use client"
import React, {useCallback, useState} from 'react';
import ReactJson from 'react-json-view';
import './style.scss';
import {SendTransactionRequest, useTonConnectUI, useTonWallet} from "@tonconnect/ui-react";

const defaultTx: SendTransactionRequest = {
  validUntil: Math.floor(Date.now() / 1000) + 600,
  messages: [
    {
      address: '0:8a5a9c7b70d329be670de4e6cce652d464765114aa98038c66c3d8ceaf2d19b0',
      amount: '5000000',
      stateInit: 'te6cckEBBAEAOgACATQCAQAAART/APSkE/S88sgLAwBI0wHQ0wMBcbCRW+D6QDBwgBDIywVYzxYh+gLLagHPFsmAQPsAlxCarA==',
      payload: 'te6ccsEBAQEADAAMABQAAAAASGVsbG8hCaTc/g==',
    },
  ],
};

export function TxForm() {
  const [tx, setTx] = useState(defaultTx);
  const wallet = useTonWallet();
  const [tonConnectUi] = useTonConnectUI();

  const onChange = useCallback((value: object) => setTx((value as { updated_src: typeof defaultTx }).updated_src), []);

  return (
    <div className="send-tx-form">
      <h3>Configure and send transaction</h3>
      <ReactJson src={defaultTx} theme="ocean" onEdit={onChange} onAdd={onChange} onDelete={onChange} />
      {wallet ? (
        <button onClick={() => tonConnectUi.sendTransaction(tx)}>
          Send transaction
        </button>
      ) : (
        <button onClick={() => tonConnectUi.openModal()}>Connect wallet to send the transaction</button>
      )}
    </div>
  );
}


'src/components/Header/Header.tsx'

This component displays the header of the application and includes the TON wallet connection button.

import {TonConnectButton} from "@tonconnect/ui-react";
import './header.scss';

export const Header = () => {
  return <header>
    <span>My App with React UI</span>
    <TonConnectButton />
  </header>
}


'src/components/TonProofDemo/TonProofDemo.tsx'

This component demonstrates the backend API integration with TON proof verification.

import React, {useCallback, useEffect, useRef, useState} from 'react';
import ReactJson from 'react-json-view';
import './style.scss';
import {TonProofDemoApi} from "@/app/TonProofDemoApi";
import {useTonConnectUI, useTonWallet} from "@tonconnect/ui-react";
import {CHAIN} from "@tonconnect/ui-react";
import useInterval from "@/src/lib/hooks/useInterval";

export const TonProofDemo = () => {
  const firstProofLoading = useRef<boolean>(true);
  const [data, setData] = useState({});
  const wallet = useTonWallet();
  const [authorized, setAuthorized] = useState(false);
  const [tonConnectUI] = useTonConnectUI();

  const recreateProofPayload = useCallback(async () => {
    if (firstProofLoading.current) {
      tonConnectUI.setConnectRequestParameters({ state: 'loading' });
      firstProofLoading.current = false;
    }

    const payload = await TonProofDemoApi.generatePayload();

    if (payload) {
      tonConnectUI.setConnectRequestParameters({ state: 'ready', value: payload });
    } else {
      tonConnectUI.setConnectRequestParameters(null);
    }
  }, [tonConnectUI, firstProofLoading])

  if (firstProofLoading.current) {
    recreateProofPayload();
  }

  useInterval(recreateProofPayload, TonProofDemoApi.refreshIntervalMs);

  useEffect(() =>
    tonConnectUI.onStatusChange(async w => {
      if (!w || w.account.chain === CHAIN.TESTNET) {
        TonProofDemoApi.reset();
        setAuthorized(false);
        return;
      }

      if (w.connectItems?.tonProof && 'proof' in w.connectItems.tonProof) {
        await TonProofDemoApi.checkProof(w.connectItems.tonProof.proof, w.account);
      }

      if (!TonProofDemoApi.accessToken) {
        tonConnectUI.disconnect();
        setAuthorized(false);
        return;
      }

      setAuthorized(true);
    }), [tonConnectUI]);

  const handleClick = useCallback(async () => {
    if (!wallet) {
      return;
    }
    const response = await TonProofDemoApi.getAccountInfo(wallet.account);
    setData(response);
  }, [wallet]);

  if (!authorized) {
    return null;
  }

  return (
    <div className="ton-proof-demo">
      <h3>Demo backend API with ton_proof verification</h3>
      {authorized ? (
        <button onClick={handleClick}>
          Call backend getAccountInfo()
        </button>
      ) : (
        <div className="ton-proof-demo__error">Connect wallet to call API</div>
      )}
      <ReactJson src={data} name="response" theme="ocean" />
    </div>
  );
}


'src/components/TonConnectProvider.tsx'

This component wraps the application with the TON Connect UI provider, setting up the wallet connection.

"use client";

import React from 'react';
import { THEME, TonConnectUIProvider } from "@tonconnect/ui-react";
import { Header } from "@/src/components/Header/Header";
import { TxForm } from "@/src/components/TxForm/TxForm";
import "@/app/trackers";

const TonConnectProvider = ({ children }: { children: React.ReactNode }) => {
  return (
    <TonConnectUIProvider
      manifestUrl="https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json"
      uiPreferences={{ theme: THEME.DARK }}
      walletsListConfiguration={{
        includeWallets: [
          {
            appName: "safepalwallet",
            name: "SafePal",
            imageUrl: "https://s.pvcliping.com/web/public_image/SafePal_x288.png",
            aboutUrl: "https://www.safepal.com/download",
            jsBridgeKey: "safepalwallet",
            platforms: ["ios", "android", "chrome", "firefox"]
          },
          {
            appName: "tonwallet",
            name: "TON Wallet",
            imageUrl: "https://wallet.ton.org/assets/ui/qr-logo.png",
            aboutUrl: "https://chrome.google.com/webstore/detail/ton-wallet/nphplpgoakhhjchkkhmiggakijnkhfnd",
            universalLink: "https://wallet.ton.org/ton-connect",
            jsBridgeKey: "tonwallet",
            bridgeUrl: "https://bridge.tonapi.io/bridge",
            platforms: ["chrome", "android"]
          }
        ]
      }}
      actionsConfiguration={{
        twaReturnUrl: 'https://t.me/tc_twa_demo_bot/start'
      }}
    >
      <div className="app">
        <Header />
        <TxForm />
        {children}
      </div>
    </TonConnectUIProvider>
  );
};

export default TonConnectProvider;


'package.json'

This file lists the dependencies and scripts for the project.

{
  "name": "dapp-ton-next",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "react": "^18",
    "react-dom": "^18",
    "next": "14.2.3",
    "@tonconnect/ui-react": "^2.0.2",
    "apexcharts": "^3.48.0",
    "autoprefixer": "^10.4.19",
    "axios": "^1.6.8",
    "buffer": "^6.0.3",
    "chart.js": "^4.4.2",
    "dotenv": "^16.4.5",
    "eruda": "^2.11.3",
    "express": "^4.19.2",
    "flowbite": "^2.3.0",
    "pg": "^8.11.5",
    "postcss": "^8.4.38",
    "react-json-view": "^1.21.3",
    "react-router-dom": "^6.22.3",
    "react-toastify": "^10.0.5",
    "tailwindcss": "^3.4.3",
    "terser": "^5.31.0",
    "tonweb": "^0.0.41"
  },
  "devDependencies": {
    "typescript": "^5",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "eslint": "^8",
    "eslint-config-next": "14.2.3",
    "@svgr/core": "^8.1.0",
    "@types/express": "^4.17.21",
    "@types/pg": "^8.11.4",
    "daisyui": "^4.9.0",
    "sass": "^1.57.1"
  }
}


Conclusion

This project demonstrates how to integrate a TON blockchain wallet into a Next.js application, providing functionality for user authentication, session management, and transaction handling. Feel free to explore the code and adapt it to your needs.
